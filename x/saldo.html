<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cashback Kort</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;600&display=swap" />
  <style>
    body {
      margin: 0;
      background: #f0f2f5;
      font-family: 'Rubik', sans-serif;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }
    input {
      padding: 10px;
      font-size: 1em;
      border-radius: 8px;
      border: 1px solid #ccc;
      width: 220px;
      text-align: center;
      letter-spacing: 1px;
    }
    .card {
      background: linear-gradient(145deg, #0f2027, #203a43, #2c5364);
      color: #fff;
      width: 340px;
      height: 200px;
      border-radius: 18px;
      padding: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .top-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.9em;
      opacity: 0.85;
    }
    .balance {
      font-size: 3em;
      font-weight: bold;
      text-align: center;
      margin-top: 10px;
      letter-spacing: 1px;
    }
    .label {
      font-size: 0.8em;
      text-align: center;
      opacity: 0.7;
    }
    .owner {
      font-size: 1.1em;
      font-weight: 500;
      text-align: left;
      margin-top: 10px;
    }
    .info {
      font-size: 0.8em;
      text-align: right;
      opacity: 0.75;
    }
  </style>
</head>
<body>

<input id="phoneInput" placeholder="Telefon (8 siffer)" maxlength="8" />

<div class="card">
  <div class="top-row">
    <div>KØL Cashback</div>
    <div id="clientOrderCount">#</div>
  </div>
  <div>
    <div class="balance"><span id="total">0</span> kr</div>
    <div class="label">Cashback saldo</div>
  </div>
  <div class="bottom-row">
    <div class="owner" id="name">...</div>
    <div class="info" id="info">...</div>
  </div>
</div>

<script>
  const phoneInput = document.getElementById("phoneInput");
  const phoneHeader = document.createElement("div");
  phoneHeader.style.marginBottom = "10px";
  phoneHeader.style.fontSize = "0.9em";
  phoneHeader.style.color = "#27ae60";
  document.body.insertBefore(phoneHeader, phoneInput);

  // Sayfa açılışında localStorage varsa çalıştır
  window.addEventListener("DOMContentLoaded", () => {
    const savedPhone = localStorage.getItem("cashbackPhone");
    if (savedPhone) {
      phoneInput.value = savedPhone;
      fetchData(savedPhone);
      phoneHeader.textContent = '✅ Nummeret ditt er registrert!';
    }
  });

  // 8 hane olunca otomatik blur ve sorgu
  phoneInput.addEventListener("input", () => {
    const num = phoneInput.value.trim();
    if (num.length === 8) {
      phoneInput.blur();
      localStorage.setItem("cashbackPhone", num);
      fetchData(num);
      phoneHeader.textContent = '✅ Nummeret ditt er registrert!';
    }
  });

  function fetchData(phone) {
    const url = `https://bestill-pizza-default-rtdb.europe-west1.firebasedatabase.app/orders/${phone}.json`;
    fetch(url)
      .then(r => r.json())
      .then(d => {
        document.getElementById("total").textContent = Math.round((d.total || 0) * 0.05);
        document.getElementById("name").textContent = `${d.raw.client_first_name} ${d.raw.client_last_name}`;
        document.getElementById("clientOrderCount").textContent = `#${d.raw.client_order_count || 1}`;

        const updated = new Date(d.raw.updated_at).toLocaleDateString("no-NO", {
          day: '2-digit', month: 'short', year: 'numeric'
        });
        document.getElementById("info").textContent = `siste shopping: ${updated}`;
      })
      .catch(() => {
        document.getElementById("total").textContent = "0";
        document.getElementById("name").textContent = "Ugyldig nummer";
        document.getElementById("info").textContent = "";
        document.getElementById("clientOrderCount").textContent = "#";
        phoneHeader.textContent = '⛔ Nummer ikke funnet';
      });
  }
</script>


</body>
</html>
