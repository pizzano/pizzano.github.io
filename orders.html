<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <title>Bestillinger</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .receipt {
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 25px;
      max-width: 550px;
      background: #f9f9f9;
    }
    .title {
      font-weight: bold;
      font-size: 1.2em;
      margin-bottom: 10px;
    }
    .section {
      margin: 10px 0;
    }
    .product {
      margin: 5px 0;
    }
    .option {
      margin-left: 20px;
      font-style: italic;
      color: #555;
    }
    .note {
      color: red;
      font-weight: bold;
      margin-left: 20px;
    }
    .ready {
      background: green;
      color: white;
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.9em;
    }
    .status-pending {
      background: orange;
      color: white;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.9em;
    }
  </style>
</head>
<body>

  <h2>ğŸ§¾ Siste Bestillinger</h2>
  <div id="orderContainer"></div>

  <script>
    const sheetId = '1FMJw_fPR_KxxPSjiaVGIq86E91YazxaO09zqUnCYjb8';
    const sheetName = 'Sayfa1';
    const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${sheetName}`;

    fetch(url)
      .then(res => res.text())
      .then(text => {
        const json = JSON.parse(text.match(/(?<=\().*(?=\);)/)[0]);
        const rows = json.table.rows;
        const container = document.getElementById('orderContainer');

        rows.forEach(row => {
          const raw = row.c[0]?.v;
          if (!raw) return;

          try {
            const order = JSON.parse(raw).orders[0];

            const dato = new Date(order.fulfill_at).toLocaleString("no-NO");
            const navn = `${order.client_first_name} ${order.client_last_name}`;
            const telefon = order.client_phone;
            const status = order.status === "accepted" ? "âœ… Godkjent" : "ğŸ•“ Venter";
            const betaling = order.payment;
            const total = order.total_price + ' ' + order.currency;
            const klar = order.ready ? '<span class="ready">ğŸ½ Klar â€“ Hentes nÃ¥!</span>' : '<span class="status-pending">Ikke klar</span>';

            let html = `<div class="receipt">
              <div class="title">ğŸ“¦ ${status} â€” ${dato}</div>
              <div class="section">ğŸ‘¤ <strong>${navn}</strong><br>ğŸ“ ${telefon}</div>
              <div class="section">ğŸ’³ Betaling: ${betaling}<br>ğŸ’° Total: <strong>${total}</strong></div>
              <div class="section">â±ï¸ Status: ${klar}</div>
              <hr>
              <div class="section">ğŸ• <strong>Produkter:</strong><br>`;

            order.items.forEach(item => {
              html += `<div class="product">ğŸ”¹ ${item.quantity} x ${item.name} â€“ ${item.total_item_price} NOK</div>`;
              if (item.options && item.options.length > 0) {
                item.options.forEach(opt => {
                  if (opt.name) {
                    html += `<div class="option">â€¢ ${opt.name}</div>`;
                  }
                });
              }
              if (item.instructions) {
                html += `<div class="note">â— ${item.instructions}</div>`;
              }
            });

            html += `</div></div>`;
            container.innerHTML += html;

          } catch (err) {
            console.warn('JSON parse error:', err);
          }
        });
      })
      .catch(err => console.error('Feil under lasting:', err));
  </script>

</body>
</html>
