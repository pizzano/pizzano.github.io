<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Satƒ±r Bul ve C G√ºncelle</title>
</head>
<body>
  <h3>Toplam G√ºncelle (Telefon: 41234567)</h3>

  <div id="sonuc" style="display:none;">
    <p><strong>Telefon:</strong> <span id="a"></span></p>
    <p><strong>Navn:</strong> <span id="b"></span></p>
    <p>
      <strong>Total:</strong>
      <input type="number" id="total">
      <button onclick="guncelle()">G√ºncelle</button>
    </p>
  </div>

  <script>
    const sheetURL = "https://docs.google.com/spreadsheets/d/1l2mhvtjSGTh4u8amSBnK_oSUI665TqHz_CNWduzEwEA/gviz/tq?tqx=out:json&sheet=Sayfa1";
    const scriptURL = "https://script.google.com/macros/s/AKfycbx1PgWOKAaBjxZecEUFN9Y7mWzwBU3IY3oV9Ya8uRskk5JXrgO20KAaP7q9FxXKqwg8/exec";
    const telefonGirilen = "41234567";
    let rowIndex = null;

    // Sayfa a√ßƒ±lƒ±r a√ßƒ±lmaz A s√ºtununda telefon numarasƒ±nƒ± ara
    window.onload = () => {
      alert("Sayfa y√ºklendi. Satƒ±r aranƒ±yor...");
      fetch(sheetURL)
        .then(res => res.text())
        .then(txt => {
          const json = JSON.parse(txt.match(/(?<=\().*(?=\);)/)[0]);
          const rows = json.table.rows;
          alert("Veri √ßekildi. " + rows.length + " satƒ±r var.");

          let bulundu = false;
          rows.forEach((r, i) => {
            const tel = r.c[0]?.v?.toString();
            if (tel === telefonGirilen) {
              alert(`E≈üle≈üme bulundu: Satƒ±r ${i + 1}`);
              document.getElementById("a").textContent = r.c[0]?.v || "";
              document.getElementById("b").textContent = r.c[1]?.v || "";
              document.getElementById("total").value = r.c[2]?.v || "";
              rowIndex = i + 1;
              document.getElementById("sonuc").style.display = "block";
              bulundu = true;
            }
          });

          if (!bulundu) {
            alert("‚õî Telefon bulunamadƒ±!");
            document.getElementById("sonuc").style.display = "none";
          }
        })
        .catch(err => alert("‚ùå Veri alƒ±namadƒ±: " + err));
    };

    // G√ºncelle butonuna basƒ±lƒ±nca sadece C s√ºtununu g√∂nder
    function guncelle() {
      const total = document.getElementById("total").value;
      if (!rowIndex) {
        alert("‚õî Satƒ±r bulunmadan g√ºncelleme yapƒ±lamaz!");
        return;
      }

      alert(`üü¢ G√ºncelle ba≈ülatƒ±lƒ±yor\nSatƒ±r: ${rowIndex}\nYeni Total: ${total}`);

      fetch(scriptURL, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `editC=${rowIndex}&total=${encodeURIComponent(total)}`
      })
      .then(res => res.text())
      .then(msg => {
        alert("‚úÖ Sunucudan gelen yanƒ±t:\n" + msg);
      })
      .catch(err => {
        alert("‚ùå G√ºncelleme hatasƒ±:\n" + err);
      });
    }
  </script>
</body>
</html>
